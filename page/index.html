<!DOCTYPE html>
<html lang="">
  <head>
  <meta content="text/html;charset=utf-8" http-equiv="Content-Type">
  <meta content="utf-8" http-equiv="encoding">
    
  <script src="jspack.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/js-sha3/0.8.0/sha3.min.js" integrity="sha512-PmGDkK2UHGzTUfkFGcJ8YSrD/swUXekcca+1wWlrwALIZho9JX+3ddaaI9wmmf8PmgDIpMtx6TU8YBJAZS0mPQ==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/aes-js/4.0.0-beta.2/index.min.js" integrity="sha512-H9KqUQpRsqGUaA2pm2FkHZX4wFhgDwE70o2PUS0Cx7V1PJjBh2J5YZnSaI/u0m9zv/Cx3qvMI48/OZz7/o47xQ==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
  <script type="text/javascript">
    main = function() {
      document.getElementById('send_button').onclick = function() {message_to_bytes()};
      document.getElementById('join_button').onclick = function() {
        document.getElementById('join_button').remove();
        draw_on();
        mainloop("")
      };
      var ws_ip_port = 'ws://' + location.host + "/ws";
      const socket = new WebSocket(ws_ip_port);
      socket.onopen = function() {console.log("socket opened");};
      socket.onerror = function(e) {console.log('ws error!'+e.code+e.reason);};
      socket.onclose = function(e) {console.log('ws closed!'+e.code+e.reason);};
      socket.onmessage = function(e) {ws_receive(e)};
      function ws_send(bytes) {
        if (socket.readyState != WebSocket.OPEN) {
          console.log('Tried sending to closed WS');
          return;
        }

        var outgoing = new Uint8Array(bytes);
        socket.send(outgoing);
        // For printing and debugging
        //var outbound_hex = aesjs.utils.hex.fromBytes(bytes);
        //console.log("Sent:\n " + outbound_hex);
        /*console.log("Sent: ");
        console.log(outgoing);*/
      };
      function ws_receive(message_event) {
        var blob = message_event.data;
        reader.readAsArrayBuffer(blob);
      }

      function read_message_bytes(bytes) {
        if (bytes == null || bytes == []) {
          console.log('recevied empty');
          return;
        }
        var message_byte_size = 180;
        while(bytes.length > 0) {
          var single_message = bytes.splice(0, message_byte_size);
          bytes_to_message(single_message);
          bytes = bytes.splice(message_byte_size, bytes.length);
        }
      };

      var reader = new FileReader();
      reader.onload = function() {
        var result = reader.result;
        var bytes_u8_array = new Uint8Array(result);
        var bytes = Array.from(bytes_u8_array);
        read_message_bytes(bytes);
        // For printing and debugging
        /*console.log('received:');*/
        //console.log(reader.result);
      }
      var struct = new JSPack();
      var max_chat_id = 0;
      var min_chat_id = Number.MAX_SAFE_INTEGER;

      function get_title(){return document.getElementById('title').value;}
      function get_password(){return document.getElementById('password').value;}
      function get_message(){return document.getElementById('message_entry').value;}
      function clear_messages(){document.getElementById('message_list').replaceChildren();}

      function draw_on() {
        var title_div = document.getElementById('title_div');
        var stop_button = document.createElement("div");
        var stop_square = document.createElement("div");
        stop_button.onclick = function() {
          //document.getElementById('title').value = "";
          setTimeout(function() {document.getElementById('stop_button').remove();}, 1000);
        };
        stop_button.id = "stop_button";
        stop_square.id = "stop_square";
        stop_button.appendChild(stop_square);
        title_div.appendChild(stop_button);
      };
      function draw_off() {
        var title_div = document.getElementById('title_div');
        var join_button = document.createElement("div");
        var join_triangle_top = document.createElement("div");
        var join_triangle_bot = document.createElement("div");
        join_button.onclick = function() {
          document.getElementById('join_button').remove();
          draw_on();
          mainloop("")
        };
        join_button.id="join_button";
        join_triangle_bot.id = "join_triangle_bot";
        join_triangle_top.id = "join_triangle_top";  
        join_button.appendChild(join_triangle_top);
        join_button.appendChild(join_triangle_bot);
        title_div.appendChild(join_button);
      };

      function mainloop(old_title) {
        var title = get_title();
        if (title == "") {  // make new button to start the mainloop again
          draw_off();
          return;
        }
        // check if chat title has changed
        if (title == old_title) {
          // update chat list to new title
          clear_messages();
          max_chat_id = 0;
          min_chat_id = Number.MAX_SAFE_INTEGER;
          fetch_messages(title);
        } else {
          query_messages(title, max_chat_id);
        }
        setTimeout(function() {mainloop(title);}, 500);
      };

      function fetch_messages(title) {
        var chat_key = sha3_256.array(title);
        var chat_id = sha3_256.array(chat_key);
        var outbound_bytes = struct.Pack('3s32A3s', ["fch", chat_id, "end"]);
        ws_send(outbound_bytes);
      };
      function query_messages(title, message_id) {
        var chat_key = sha3_256.array(title);
        var chat_id = sha3_256.array(chat_key);
        var query = 0xff_00_00_00 + max_chat_id;
        var outbound_bytes = struct.Pack('3s32AI3s', ["qry", chat_id, query, "end"]);
        ws_send(outbound_bytes);
      };

      function message_to_bytes() {      
        // message: ["snd", chat_id, user_id, cypher, "end"]
        var title = get_title();        // known by peers
        var password = get_password();  // private
        var message = get_message();    // known by peers
        var epoc_time = Date.now();     // known by peers

        var chat_key = sha3_256.array(title);  // known by peers
        var chat_id = sha3_256.array(chat_key);  // chat key is public
        var user_id = sha3_256.array(password);  // user id is public

        message = message.padEnd(128);
        var text_bytes = aesjs.utils.utf8.toBytes(message);
        var aes_cnt = new aesjs.ModeOfOperation.ctr(chat_key, new aesjs.Counter(1));
        var encrypted_bytes = aes_cnt.encrypt(text_bytes);
        
        var pad_start = "snd";
        var pad_end = "end";
        var struct = new JSPack();
        var outbound_bytes = struct.Pack('3s32A32A128A3s', [pad_start, chat_id, user_id, encrypted_bytes, pad_end]);
        
        ws_send(outbound_bytes); 
      };

      function bytes_to_message(bytes) {
        //message: Message ID, Time, USER ID, Message cypher, Signature
        var unpack = struct.Unpack('I16A32A128A', bytes, 0);
        var message_id = unpack[0];  // load this into a global variable
        max_chat_id = Math.max(max_chat_id, message_id);
        var time = unpack[1];
        var user_id = unpack[2];
        var encrypted_bytes = unpack[3];
        //var Signature = unpack[4];   // veryify this at some point

        // username
        var username_string = aesjs.utils.hex.fromBytes(user_id);

        // date string
        var epoc = time[0] << 20; // bytes_to_int(time) todo
        var date = new Date(epoc); 
        var date_string = date.toLocaleString('en-GB', { hour12:false } );

        // message text
        var title = get_title();
        var chat_key = sha3_256.array(title);
        var aes_cnt = new aesjs.ModeOfOperation.ctr(chat_key, new aesjs.Counter(1));
        var decrypted_bytes = aes_cnt.decrypt(encrypted_bytes);
        var message_string = aesjs.utils.utf8.fromBytes(decrypted_bytes); 
        //console.log(message_string);

        build_message(username_string, date_string, message_string)
      };
      
      function build_message(username_string, date_string, message_string) {
        let message_list_div = document.getElementById('message_list');

        var msg_div = document.createElement('div');
        var usr_div = document.createElement('div');
        var time_div = document.createElement('div');
        var content_div = document.createElement('div');

        msg_div.className = 'message';
        usr_div.className = 'username';
        time_div.className = 'time';
        content_div.className = 'content';

        usr_div.innerHTML = username_string;
        time_div.innerHTML = date_string;
        content_div.innerHTML = message_string;

        msg_div.appendChild(usr_div);
        msg_div.appendChild(time_div);
        msg_div.appendChild(content_div);
        message_list_div.appendChild(msg_div);
      };
      function send_message() {
        var bytes = message_to_bytes();
        document.getElementById('message_entry').innerHTML = "";
      };
    };
    window.onload = main;
  </script>

  <style>
    body {
      background: #f5f5f5
    }
    .everything{
      width: 100%;
      height: 100%;
    }
    .title{
      position: fixed;
      top: 0px;
      left: 0px;
      width: 100%;
      height: 50px;
      background: #E0DEDE;
      /*margin-left: 1%;
      margin-right: 1%;*/
      border: none;
      border-bottom: 3px solid #6a197d;
      font-size: 30px;
      font-family: verdana;
    }
    .password{
      width: 100%;
      height: 30px;
      background: #E0DEDE;
      margin: none;
      border: none;
      font-size: 30px;
      font-family: verdana;
      margin: 2px 1% 2px;
    }
    .message_entry{
      width: 100%;
      height: 50px;
      background: #E0DEDE;
      margin: none;
      border: none;
      border-top: 3px solid #6a197d;
      font-size: 22px;
      font-family: verdana;
    }
    .bottom{ 
      bottom: 0px;
      left: 0px;
      position: fixed;
      background: #E0DEDE;
      width: 100%;
      height: 95px;
      /*margin: 0% 0% 0px;*/
    }
    .inputs{ 
      width: 96%;
      float: left;
    }
    .message_list{
      width: 99%;
      margin-top:  60px;
      margin-bottom: 100px;
    }
    .message{
      border-radius: 12px;
      background: #e2cee7;
      margin-bottom:  15px;
      margin-left:  10px;
      margin-right:  10px;
    }
    .message2{
      border-radius: 12px;
      background: #c59fcf;
      margin-bottom:  15px;
      margin-left:  10px;
      margin-right:  10px;
    }
    .username{
      margin-left:  10px;
      border-bottom: 1px solid #6a197d;
      font-size: 14px;
      font-family: verdana;
    }
    .time{
      margin-left:  6px;
      font-size: 10px;
      font-family: verdana;
    }
    .content{
      margin-left:  7px;
      font-size: 17px;
      font-family: verdana;
    }

    #send_button {
      float: right;
      position: absolute;
      z-index: 100;
      top: 10px;
      right: 10px;

      width: 45px;
      height: 45px;
      padding: 16px;

      border-radius: 45%;

      background: #6a197d;
    }
    #triangle_top {
      position: absolute;
      /* position */
      top: 12px;
      left: 16px;
      /* size */
      border-bottom: 25px solid white;
      border-right: 55px solid transparent;
    }
    #triangle_bot {
      position: absolute;
      /* position */
      top: 39px;
      left: 16px;
      /* size */
      border-top: 25px solid white;
      border-right: 55px solid transparent;
    }
    #join_button {
      float: right;
      position: absolute;
      z-index: 100;
      top: 4px;
      right: 4px;

      width: 33px;
      height: 33px;
      padding: 6px;

      border-radius: 40%;
      background: #6a197d;
    }
    #join_triangle_top {
      position: absolute;
      /* position */
      top: 9px;
      left: 12px;
      /* size */
      border-bottom: 13px solid white;
      border-right: 25px solid transparent;
    }
    #join_triangle_bot {
      position: absolute;
      /* position */
      top: 22px;
      left: 12px;
      /* size */
      border-top: 13px solid white;
      border-right: 25px solid transparent;
    }

    #stop_button {
      float: right;
      position: absolute;
      z-index: 100;
      top: 4px;
      right: 4px;

      width: 33px;
      height: 33px;
      padding: 6px;

      border-radius: 40%;
      background: #6a197d;
    }
    #stop_square {
      position: absolute;
      /* position */
      top: 12px;
      left: 12px;
      /* size */
      border-top: 21px solid white;
      border-right: 21px solid white;
    }

  </style>
    <title>Publichat</title>
  </head>

  <body height="100%" width=100% class="everything">
    <div id="title_div">
      <input type="text" class="title" id="title" placeholder="Title" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false">
      <div id="join_button">
        <div id="join_triangle_top"></div>
        <div id="join_triangle_bot"></div>
      </div>
    </div>
    
    <div class="message_list" id="message_list">
      <div class="message">
        <div class="username">WZRHGrsBESr8wYFZ</div>
        <div class="time">22:25 - 11 March 2020</div>
        <div class="content">Beethoven remains one of the most admired composers in the history of Western music</div>
      </div>
    </div>

    <div class="bottom">
      <div class="inputs">
        <input type="text" class="password" id="password" placeholder="Secret Identifier" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false">
        <input type="text" class="message_entry" id="message_entry" placeholder="Write message here..." >
      </div>
      <div id="send_button">
        <div id="triangle_top"></div>
        <div id="triangle_bot"></div>
      </div>
    </div>
  </body>
</html>
